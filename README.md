# Разработка юридического ассистента на основе LLM

## Постановка задачи

Разработка модуля интеллектуального поиска документов в базе данных (retriever)
для юридического ассистента, основанного на больших языковых моделях (LLM).

На текущий момент без помощи юриста сложно быстро находить нужные статьи и
законы в больших объёмах правовых документов. Разрабатываемый модуль retrieval
будет помогать в этом: он сможет по конкретному запросу пользователя находить
релевантные фрагменты законов и нормативных актов, подготавливая контекст для
последующей обработки ассистентом.

Для обеспечения корректного и точного поиска требуется обученная векторная
модель, способная:

- понимать контекст нормативно-правовых актов,
- находить семантически близкие фрагменты,
- корректно ранжировать результаты,
- готовить контекст для последующей генерации ответа LLM.

В рамках проекта разрабатывается retrieval-модель, а также создаётся векторная
база данных, на которой будет основана работа юридического ассистента.

## Формат входных и выходных данных

### Входные данные

**Пользовательский запрос:**

- строка (str, 5–200 символов), например:
  ```
  "Какие штрафы предусмотрены за нарушение условий договора с поставщиком?"
  ```

## Метрики

Для задачи retrieval-поиска ключевые метрики:

### 1. Recall@k

Показывает, найден ли правильный фрагмент среди первых k результатов.

Высокий recall важнее precision, т.к. retrieved документы затем проходят
reranking/LLM-обработку.

### 2. MRR (Mean Reciprocal Rank)

Отражает позицию первого релевантного ответа.

### 3. nDCG@k (Normalized Discounted Cumulative Gain)

Оценивает качество ранжирования с учетом позиции релевантных результатов.

## Датасеты

Используемые источники юридических данных:

### 1. [Russian Legal Documents](https://www.kaggle.com/datasets/nzibben/20-russian-legal-documents)

Около 2000 страниц российских юридических документов. На русском языке. В
сборнике датасетов есть файлы docx, rtf форматов (в них около 800 000 слов),
файлы pdf формата (в них около 1 500 000 слов). Общий вес документов 118.03 Мб.

### 2. [Rossiyskaya Gazeta Papers (Russian legal texts)](https://www.kaggle.com/datasets/athugodage/russian-legal-text-parallel-corpus)

Данные с веб-сайта "Российской газеты", издаваемой правительством России уже в
формате csv. Набор данных содержит законодательные документы с 31 декабря 2008
года по 28 ноября 2022 года. Всего в датасете 2963 семпла (154.81 Мб). Датасет
содержит 5 колонок:

- Название документа (Document Title)
- Ссылка (Link to the original document)
- Текст (Original document text)
- Комментарий РГ (Rossiyskaya Gazeta comment)
- Дата (Publication date)

## Архитектура

- **Модель эмбеддингов:** intfloat/multilingual-e5-large
- **Векторная база данных:** Qdrant
- **LLM-генератор:** Qwen/Qwen2.5-0.5B-Instruct (локальная модель)
- **API-сервис на FastAPI:**
  - `/embed` — генерация эмбеддингов
  - `/search` — поиск релевантных фрагментов
  - `/answer` — подготовка контекста для LLM
  - `/generate` — генерация ответа на основе найденных статей

**Пайплайн будет включать:**

1. предобработку текстов законов;
2. чанкирование;
3. создание эмбеддингов;
4. индексирование в векторную БД;
5. пул запросов от пользователя.

---

## Технические детали

### Setup

#### Требования

- Python 3.12+
- [uv](https://github.com/astral-sh/uv) — менеджер пакетов и окружений
- Qdrant — векторная база данных (локально или облачная)

#### Установка зависимостей

Склонировать репозиторий и перейти в директорию проекта:

```bash
cd russian_laws
```

Установить зависимости проекта:

```bash
uv sync
```

Настроить переменные окружения:

Создать файл `.env` в корне проекта (или экспортировать переменные):

```bash
export QDRANT_URL="your_host"
export QDRANT_API_KEY="your_api_key"

export AWS_ACCESS_KEY_ID="your_access_key"
export AWS_SECRET_ACCESS_KEY="your_secret_key"
```

#### Установка dev-зависимостей (опционально)

Для разработки и работы с данными:

```bash
uv sync --group dev
```

#### Настройка pre-commit

Для автоматической проверки кода:

```bash
uv run pre-commit install
```

### API

#### Запуск FastAPI сервиса

```bash
uv run python russian_laws/api.py
```

#### Эндпоинты API

После запуска сервиса доступны следующие эндпоинты:

- **`POST /embed`** — генерация эмбеддинга для текста
  ```json
  {
    "text": "Текст для эмбеддинга"
  }
  ```
- **`POST /search`** — поиск релевантных статей
  ```json
  {
    "query": "Запрос",
    "limit": 10,
    "score_threshold": 0.5
  }
  ```
- **`POST /answer`** — подготовка контекста для LLM
  ```json
  {
    "query": "Запрос",
    "limit": 5
  }
  ```
- **`POST /generate`** — генерация ответа с использованием LLM
  ```json
  {
    "query": "Запрос",
    "limit": 5,
    "score_threshold": 0.5
  }
  ```

### Структура проекта

```
russian_laws/
├── conf/                    # Конфигурации Hydra
│   ├── config.yaml          # Основной конфиг
│   ├── embedding/           # Конфигурация модели эмбеддингов
│   ├── generator/           # Конфигурация LLM-генератора
│   └── qdrant/              # Конфигурация Qdrant
├── data/
│   ├── processed/           # Обработанные данные
│   └── raw/                 # Исходные данные
├── russian_laws/            # Основной пакет
│   ├── api.py               # FastAPI сервис
│   ├── embeddings.py        # Модель эмбеддингов
│   ├── generator.py         # LLM-генератор ответов
│   ├── indexer.py           # Индексация статей в Qdrant
│   ├── qdrant_manager.py    # Менеджер Qdrant
│   └── test.py              # Тестирование retrieval
├── scripts/                 # Вспомогательные скрипты
└── pyproject.toml           # Зависимости проекта
```
